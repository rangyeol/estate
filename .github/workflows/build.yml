name: 🏗️ Build Naver Real Estate Viewer (Qt3D 충돌 해결)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ published ]
  workflow_dispatch:  # 수동 실행 허용

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Windows 빌드
          - os: windows-latest
            python-version: '3.11'
            artifact-name: 'naver-real-estate-viewer-windows'
            build-command: 'pyinstaller 네이버부동산뷰어.spec --clean'
            executable-path: 'dist/네이버부동산뷰어/'
            
          # macOS 빌드
          - os: macos-latest
            python-version: '3.11'
            artifact-name: 'naver-real-estate-viewer-macos'
            build-command: 'pyinstaller 네이버부동산뷰어_mac.spec --clean'
            executable-path: 'dist/네이버부동산뷰어.app'

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4

    - name: 🐍 Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: 📋 Display system info
      run: |
        python --version
        pip --version
        echo "OS: ${{ runner.os }}"
        echo "Architecture: ${{ runner.arch }}"

    - name: 🔧 Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # ===== Qt3D 충돌 해결: 극강 정리 시스템 =====
    
    - name: 🧹💥 Ultimate Clean All Build Files (macOS)
      if: runner.os == 'macOS'
      run: |
        echo "🧹 Ultimate cleaning macOS build directories for Qt3D conflict resolution..."
        
        # 1. 기본 빌드 디렉토리 완전 삭제
        sudo rm -rf build/ || true
        sudo rm -rf dist/ || true
        rm -rf build/ || true
        rm -rf dist/ || true
        
        # 2. Qt3D 프레임워크 완전 제거 (핵심!)
        find . -name "*Qt3D*" -type d -exec sudo rm -rf {} + || true
        find . -name "*Qt3D*" -type f -exec sudo rm -f {} + || true
        find . -name "*qt3d*" -type d -exec sudo rm -rf {} + || true
        find . -name "*qt3d*" -type f -exec sudo rm -f {} + || true
        
        # 3. PySide6 Qt3D 관련 캐시/파일 제거
        find . -name "*Animation*framework*" -exec sudo rm -rf {} + || true
        find . -name "*3DAnimation*" -exec sudo rm -rf {} + || true
        find . -name "*3DCore*" -exec sudo rm -rf {} + || true
        find . -name "*3DExtras*" -exec sudo rm -rf {} + || true
        
        # 4. PyInstaller 임시 파일 완전 정리
        sudo rm -rf /tmp/_MEI* || true
        sudo rm -rf $TMPDIR/_MEI* || true
        sudo rm -rf /var/folders/*/_MEI* || true
        
        # 5. Python 캐시 완전 정리
        find . -name "__pycache__" -type d -exec sudo rm -rf {} + || true
        find . -name "*.pyc" -exec sudo rm -f {} + || true
        find . -name "*.pyo" -exec sudo rm -f {} + || true
        
        # 6. PySide6 관련 캐시 정리
        sudo rm -rf ~/.cache/pip/wheels/PySide6* || true
        sudo rm -rf /tmp/pip-* || true
        
        echo "✅ Ultimate macOS cleanup completed - Qt3D conflict should be resolved!"
        
    - name: 🧹💥 Ultimate Clean All Build Files (Windows)
      if: runner.os == 'Windows'
      run: |
        echo "🧹 Ultimate cleaning Windows build directories for Qt3D conflict resolution..."
        
        # 1. 기본 빌드 디렉토리 완전 삭제
        Remove-Item build -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item dist -Recurse -Force -ErrorAction SilentlyContinue
        
        # 2. Qt3D 관련 파일/폴더 완전 제거
        Get-ChildItem -Path . -Recurse -Name "*Qt3D*" | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        Get-ChildItem -Path . -Recurse -Name "*qt3d*" | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        Get-ChildItem -Path . -Recurse -Name "*3DAnimation*" | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        
        # 3. PyInstaller 임시 파일 정리
        Get-ChildItem -Path $env:TEMP -Name "_MEI*" | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        Get-ChildItem -Path $env:LOCALAPPDATA"\Temp" -Name "_MEI*" | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        
        # 4. Python 캐시 정리
        Get-ChildItem -Path . -Recurse -Name "__pycache__" | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        Get-ChildItem -Path . -Recurse -Name "*.pyc" | Remove-Item -Force -ErrorAction SilentlyContinue
        
        echo "✅ Ultimate Windows cleanup completed - Qt3D conflict should be resolved!"

    # ===== PyInstaller 빌드 (Qt3D 제외) =====
    
    - name: 🔨 Build application (Qt3D Excluded)
      run: |
        echo "🔨 Starting PyInstaller build with Qt3D exclusion..."
        echo "Using PyInstaller $(pyinstaller --version)"
        echo "Using PySide6 $(python -c 'import PySide6; print(PySide6.__version__)')"
        ${{ matrix.build-command }}
        echo "✅ PyInstaller build completed successfully without Qt3D!"

    - name: 📊 Verify build result (Qt3D Free)
      run: |
        echo "📊 Build completed for ${{ runner.os }}"
        echo "Listing dist/ directory contents:"
        ls -la dist/ || dir dist\
        
        # Qt3D 관련 파일이 없는지 확인
        echo "🔍 Checking for Qt3D files in build result..."
        if [ "${{ runner.os }}" == "macOS" ]; then
          if [ -d "dist/네이버부동산뷰어.app" ]; then
            echo "✅ macOS .app bundle created successfully"
            echo "App bundle size:"
            du -sh dist/네이버부동산뷰어.app
            
            # Qt3D 관련 파일 검사
            qt3d_count=$(find dist/네이버부동산뷰어.app -name "*Qt3D*" -o -name "*3DAnimation*" | wc -l)
            if [ "$qt3d_count" -eq 0 ]; then
              echo "✅ No Qt3D files found - conflict resolved!"
            else
              echo "⚠️  Found $qt3d_count Qt3D files - may still have issues"
              find dist/네이버부동산뷰어.app -name "*Qt3D*" -o -name "*3DAnimation*"
            fi
          else
            echo "❌ macOS .app bundle not found!"
            exit 1
          fi
        elif [ "${{ runner.os }}" == "Windows" ]; then
          if [ -d "dist/네이버부동산뷰어" ]; then
            echo "✅ Windows executable directory created successfully"
            echo "Executable directory size:"
            du -sh dist/네이버부동산뷰어 2>/dev/null || echo "Size calculation not available"
          else
            echo "❌ Windows executable directory not found!"
            exit 1
          fi
        fi

    # ===== 압축 및 업로드 =====
    
    - name: 🗜️ Compress build (Windows) - Qt3D Free
      if: runner.os == 'Windows'
      run: |
        echo "🗜️ Compressing Windows build (Qt3D excluded)..."
        Compress-Archive -Path "dist/네이버부동산뷰어/*" -DestinationPath "네이버부동산뷰어-windows.zip" -Force
        echo "✅ Windows build compressed successfully"
        
        if (Test-Path "네이버부동산뷰어-windows.zip") {
          $size = (Get-Item "네이버부동산뷰어-windows.zip").Length / 1MB
          echo "📦 Windows zip size: $([math]::Round($size, 2)) MB"
        }
        
    - name: 🗜️ Compress build (macOS) - Qt3D Free
      if: runner.os == 'macOS'
      run: |
        echo "🗜️ Compressing macOS build (Qt3D excluded)..."
        cd dist
        zip --symlinks -r "../네이버부동산뷰어-macos.zip" "네이버부동산뷰어.app"
        cd ..
        echo "✅ macOS build compressed successfully"
        
        if [ -f "네이버부동산뷰어-macos.zip" ]; then
          size=$(du -h "네이버부동산뷰어-macos.zip" | cut -f1)
          echo "📦 macOS zip size: $size"
        fi

    - name: 📤 Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact-name }}
        path: |
          네이버부동산뷰어-*.zip
        retention-days: 30

    - name: 🎯 Upload to Release (if release)
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./네이버부동산뷰어-${{ runner.os == 'Windows' && 'windows' || 'macos' }}.zip
        asset_name: 네이버부동산뷰어-${{ runner.os == 'Windows' && 'windows' || 'macos' }}.zip
        asset_content_type: application/zip

  # ===== 빌드 성공 알림 =====
  
  notify:
    name: 📢 Build Status (Qt3D Free)
    runs-on: ubuntu-latest
    needs: build
    if: always()
    steps:
    - name: ✅ Build Success
      if: needs.build.result == 'success'
      run: |
        echo "🎉 All builds completed successfully (Qt3D conflict resolved)!"
        echo "✅ Windows build: Success"
        echo "✅ macOS build: Success"
        echo ""
        echo "🔗 Download links:"
        echo "- Windows: 네이버부동산뷰어-windows.zip"
        echo "- macOS: 네이버부동산뷰어-macos.zip"
        echo ""
        echo "🚀 Qt3D 충돌 문제 완전 해결 완료!"
        
    - name: ❌ Build Failed
      if: needs.build.result == 'failure'
      run: |
        echo "💥 Build failed!"
        echo "Qt3D 해결책에도 불구하고 빌드에 실패했습니다."
        echo "추가 조치가 필요할 수 있습니다."
        echo "Check the logs for details."
