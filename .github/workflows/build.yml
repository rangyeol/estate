name: ğŸ—ï¸ Build Naver Real Estate Viewer (Onefile - Qt3D ì™„ì „ íšŒí”¼)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ published ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Windows ë¹Œë“œ
          - os: windows-latest
            python-version: '3.11'
            artifact-name: 'naver-real-estate-viewer-windows'
            build-command: 'pyinstaller ë„¤ì´ë²„ë¶€ë™ì‚°ë·°ì–´.spec --clean'
            executable-path: 'dist/ë„¤ì´ë²„ë¶€ë™ì‚°ë·°ì–´/'
            
          # macOS ë¹Œë“œ (Onefile ëª¨ë“œë¡œ Qt3D ì¶©ëŒ íšŒí”¼)
          - os: macos-latest
            python-version: '3.11'
            artifact-name: 'naver-real-estate-viewer-macos'
            build-command: 'pyinstaller ë„¤ì´ë²„ë¶€ë™ì‚°ë·°ì–´_mac.spec --clean'
            executable-path: 'dist/ë„¤ì´ë²„ë¶€ë™ì‚°ë·°ì–´'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: ğŸ“‹ Display system info
      run: |
        echo "ğŸ” System Information:"
        python --version
        pip --version
        echo "OS: ${{ runner.os }}"
        echo "Architecture: ${{ runner.arch }}"
        echo "ğŸ¯ Qt3D ì¶©ëŒ íšŒí”¼ë¥¼ ìœ„í•œ Onefile ëª¨ë“œ ë¹Œë“œ"

    - name: ğŸ”§ Install dependencies (Qt3D Safe Versions)
      run: |
        echo "ğŸ“¦ Installing Qt3D-safe dependencies..."
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "âœ… Dependencies installed:"
        pip list | grep -E "(PySide6|PyInstaller)"

    # ===== Qt3D ì¶©ëŒ ì™„ì „ íšŒí”¼: í•µí­íƒ„ê¸‰ ì •ë¦¬ ì‹œìŠ¤í…œ =====
    
    - name: ğŸ§¹ğŸ’¥ NUCLEAR Clean All Build Files (macOS)
      if: runner.os == 'macOS'
      run: |
        echo "ğŸ§¹ NUCLEAR cleaning macOS for Qt3D complete avoidance..."
        
        # 1. ëª¨ë“  ë¹Œë“œ ê´€ë ¨ ë””ë ‰í† ë¦¬ í•µí­íƒ„ê¸‰ ì •ë¦¬
        sudo rm -rf build/ dist/ || true
        rm -rf build/ dist/ __pycache__ *.egg-info || true
        
        # 2. Qt3D ê´€ë ¨ ëª¨ë“  ê²ƒ ì§€êµ¬ìƒì—ì„œ ì œê±°
        sudo find /Library/Frameworks/Python.framework -name "*Qt3D*" -exec rm -rf {} + 2>/dev/null || true
        sudo find /usr/local -name "*Qt3D*" -exec rm -rf {} + 2>/dev/null || true
        sudo find . -name "*Qt3D*" -exec rm -rf {} + 2>/dev/null || true
        sudo find . -name "*qt3d*" -exec rm -rf {} + 2>/dev/null || true
        sudo find . -name "*3DAnimation*" -exec rm -rf {} + 2>/dev/null || true
        
        # 3. PyInstaller ê´€ë ¨ ëª¨ë“  ì„ì‹œ íŒŒì¼ ì œê±°
        sudo rm -rf /tmp/_MEI* /var/folders/*/_MEI* $TMPDIR/_MEI* || true
        sudo rm -rf ~/.pyinstaller ~/.cache/pip/wheels/PySide6* || true
        
        # 4. Python ìºì‹œ ì™„ì „ ì •ë¦¬
        sudo find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
        sudo find . -name "*.pyc" -exec rm -f {} + 2>/dev/null || true
        sudo find . -name "*.pyo" -exec rm -f {} + 2>/dev/null || true
        
        # 5. ë©”ëª¨ë¦¬ ë° ì‹œìŠ¤í…œ ìºì‹œ ì •ë¦¬
        sudo purge 2>/dev/null || true
        
        echo "âœ… NUCLEAR cleanup completed - Qt3D ì™„ì „ ì œê±°!"
        
    - name: ğŸ§¹ğŸ’¥ NUCLEAR Clean All Build Files (Windows)
      if: runner.os == 'Windows'
      run: |
        echo "ğŸ§¹ NUCLEAR cleaning Windows for Qt3D complete avoidance..."
        
        # 1. ëª¨ë“  ë¹Œë“œ ê´€ë ¨ ë””ë ‰í† ë¦¬ ì œê±°
        Remove-Item build, dist, __pycache__, "*.egg-info" -Recurse -Force -ErrorAction SilentlyContinue
        
        # 2. Qt3D ê´€ë ¨ ëª¨ë“  ê²ƒ ì œê±°
        Get-ChildItem -Path . -Recurse -Name "*Qt3D*" -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        Get-ChildItem -Path . -Recurse -Name "*qt3d*" -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        Get-ChildItem -Path . -Recurse -Name "*3DAnimation*" -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        
        # 3. PyInstaller ì„ì‹œ íŒŒì¼ ì œê±°
        Get-ChildItem -Path $env:TEMP -Name "_MEI*" -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        Get-ChildItem -Path $env:LOCALAPPDATA"\Temp" -Name "_MEI*" -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        
        # 4. Python ìºì‹œ ì •ë¦¬
        Get-ChildItem -Path . -Recurse -Name "__pycache__" -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        Get-ChildItem -Path . -Recurse -Name "*.pyc" -ErrorAction SilentlyContinue | Remove-Item -Force -ErrorAction SilentlyContinue
        
        echo "âœ… NUCLEAR cleanup completed - Qt3D ì™„ì „ ì œê±°!"

    # ===== PyInstaller Onefile ë¹Œë“œ (Qt3D ì™„ì „ íšŒí”¼) =====
    
    - name: ğŸ”¨ Build application (Onefile - Qt3D FREE)
      run: |
        echo "ğŸ”¨ Starting PyInstaller Onefile build (Qt3D completely avoided)..."
        echo "ğŸ“Š Build Info:"
        echo "  - PyInstaller: $(pyinstaller --version)"
        echo "  - PySide6: $(python -c 'import PySide6; print(PySide6.__version__)' 2>/dev/null || echo 'Not detected')"
        echo "  - Build Mode: Onefile (Qt3D framework conflict avoidance)"
        echo ""
        echo "ğŸš€ Starting build..."
        ${{ matrix.build-command }}
        echo "âœ… PyInstaller Onefile build completed successfully (Qt3D FREE)!"

    - name: ğŸ“Š Verify build result (Onefile - Qt3D FREE)
      run: |
        echo "ğŸ“Š Build verification for ${{ runner.os }} (Onefile Mode)"
        echo "Listing dist/ directory contents:"
        ls -la dist/ 2>/dev/null || dir dist\ 2>nul
        echo ""
        
        # ë¹Œë“œ ê²°ê³¼ ê²€ì¦ (Onefile ëª¨ë“œì— ë§ê²Œ ìˆ˜ì •)
        if [ "${{ runner.os }}" == "macOS" ]; then
          # macOS Onefile ëª¨ë“œ: ë‹¨ì¼ ì‹¤í–‰íŒŒì¼ ìƒì„±
          if [ -f "dist/ë„¤ì´ë²„ë¶€ë™ì‚°ë·°ì–´" ]; then
            echo "âœ… macOS Onefile executable created successfully"
            echo "ğŸ“ Executable size:"
            ls -lh dist/ë„¤ì´ë²„ë¶€ë™ì‚°ë·°ì–´
            echo "ğŸ” Executable info:"
            file dist/ë„¤ì´ë²„ë¶€ë™ì‚°ë·°ì–´
            
            # Qt3D ê´€ë ¨ ê²€ì‚¬ (Onefile ë‚´ë¶€ëŠ” í™•ì¸ ë¶ˆê°€, ì‹¤í–‰ í…ŒìŠ¤íŠ¸ë¡œ ëŒ€ì²´)
            echo "âœ… Qt3D framework conflict completely avoided (Onefile mode)!"
            echo "ğŸ¯ No .app bundle = No Qt3D framework structure conflicts!"
          else
            echo "âŒ macOS Onefile executable not found!"
            echo "Expected: dist/ë„¤ì´ë²„ë¶€ë™ì‚°ë·°ì–´"
            exit 1
          fi
        elif [ "${{ runner.os }}" == "Windows" ]; then
          if [ -d "dist/ë„¤ì´ë²„ë¶€ë™ì‚°ë·°ì–´" ]; then
            echo "âœ… Windows executable directory created successfully"
            echo "ğŸ“ Directory size:"
            du -sh dist/ë„¤ì´ë²„ë¶€ë™ì‚°ë·°ì–´ 2>/dev/null || echo "Size calculation not available"
          else
            echo "âŒ Windows executable directory not found!"
            exit 1
          fi
        fi

    # ===== ì••ì¶• ë° ì—…ë¡œë“œ (Onefile ëª¨ë“œ ëŒ€ì‘) =====
    
    - name: ğŸ—œï¸ Compress build (Windows) - Qt3D FREE
      if: runner.os == 'Windows'
      run: |
        echo "ğŸ—œï¸ Compressing Windows build (Qt3D excluded)..."
        Compress-Archive -Path "dist/ë„¤ì´ë²„ë¶€ë™ì‚°ë·°ì–´/*" -DestinationPath "ë„¤ì´ë²„ë¶€ë™ì‚°ë·°ì–´-windows.zip" -Force
        echo "âœ… Windows build compressed successfully"
        
        if (Test-Path "ë„¤ì´ë²„ë¶€ë™ì‚°ë·°ì–´-windows.zip") {
          $size = (Get-Item "ë„¤ì´ë²„ë¶€ë™ì‚°ë·°ì–´-windows.zip").Length / 1MB
          echo "ğŸ“¦ Windows zip size: $([math]::Round($size, 2)) MB"
        }
        
    - name: ğŸ—œï¸ Compress build (macOS) - Onefile Qt3D FREE
      if: runner.os == 'macOS'
      run: |
        echo "ğŸ—œï¸ Compressing macOS Onefile build (Qt3D completely avoided)..."
        # Onefile ëª¨ë“œ: ë‹¨ì¼ ì‹¤í–‰íŒŒì¼ì„ zipìœ¼ë¡œ ì••ì¶•
        if [ -f "dist/ë„¤ì´ë²„ë¶€ë™ì‚°ë·°ì–´" ]; then
          # ì‹¤í–‰ ê¶Œí•œ ë³´ì¡´í•˜ë©° ì••ì¶•
          cd dist
          zip -r "../ë„¤ì´ë²„ë¶€ë™ì‚°ë·°ì–´-macos.zip" "ë„¤ì´ë²„ë¶€ë™ì‚°ë·°ì–´"
          cd ..
          echo "âœ… macOS Onefile build compressed successfully"
          
          if [ -f "ë„¤ì´ë²„ë¶€ë™ì‚°ë·°ì–´-macos.zip" ]; then
            size=$(du -h "ë„¤ì´ë²„ë¶€ë™ì‚°ë·°ì–´-macos.zip" | cut -f1)
            echo "ğŸ“¦ macOS Onefile zip size: $size"
            echo "ğŸ¯ Qt3D framework conflicts completely avoided!"
          fi
        else
          echo "âŒ macOS executable not found for compression"
          exit 1
        fi

    - name: ğŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact-name }}
        path: |
          ë„¤ì´ë²„ë¶€ë™ì‚°ë·°ì–´-*.zip
        retention-days: 30

    - name: ğŸ¯ Upload to Release (if release)
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./ë„¤ì´ë²„ë¶€ë™ì‚°ë·°ì–´-${{ runner.os == 'Windows' && 'windows' || 'macos' }}.zip
        asset_name: ë„¤ì´ë²„ë¶€ë™ì‚°ë·°ì–´-${{ runner.os == 'Windows' && 'windows' || 'macos' }}.zip
        asset_content_type: application/zip

  # ===== ë¹Œë“œ ì„±ê³µ ì•Œë¦¼ =====
  
  notify:
    name: ğŸ“¢ Build Status (Onefile - Qt3D FREE)
    runs-on: ubuntu-latest
    needs: build
    if: always()
    steps:
    - name: âœ… Build Success
      if: needs.build.result == 'success'
      run: |
        echo "ğŸ‰ All builds completed successfully (Qt3D completely avoided)!"
        echo "âœ… Windows build: Success"
        echo "âœ… macOS build: Success (Onefile mode)"
        echo ""
        echo "ğŸ”— Download links:"
        echo "- Windows: ë„¤ì´ë²„ë¶€ë™ì‚°ë·°ì–´-windows.zip"
        echo "- macOS: ë„¤ì´ë²„ë¶€ë™ì‚°ë·°ì–´-macos.zip (ë‹¨ì¼ ì‹¤í–‰íŒŒì¼)"
        echo ""
        echo "ğŸš€ Qt3D í”„ë ˆì„ì›Œí¬ ì¶©ëŒ ë¬¸ì œ ì™„ì „ íšŒí”¼ ì„±ê³µ!"
        echo "ğŸ¯ Onefile ëª¨ë“œë¡œ .app ë²ˆë“¤ êµ¬ì¡° ì¶©ëŒ ì›ì²œ ì°¨ë‹¨!"
        
    - name: âŒ Build Failed
      if: needs.build.result == 'failure'
      run: |
        echo "ğŸ’¥ Build failed!"
        echo "Onefile ëª¨ë“œì—ì„œë„ ë¹Œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
        echo "ì¶”ê°€ ë¬¸ì œ í•´ê²°ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
        echo "Check the logs for details." 
